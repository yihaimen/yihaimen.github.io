---
title: "如何为异步函数写测试?"
date: 2020-06-29T19:47:44+08:00
author: "易海门"
authorLink: "https://yihaimen.github.io"
description: ""
featuredImage: ""
featuredImagePreview: ""
categories: ["JavaScript"]
tags: ["JavaScript"]
license: "Creative Commons Attribution 4.0 International license"
draft: true
---

## 0x00 引言
在实际的编码过程中，我会遇到很多的异步函数，比如网络请求。它与同步函数的不同点在于它的结果是由回调函数或promise对象返回的，也就是说在调用异步函数之后，不会像同步函数那样，被调用时会挂起，直到操作完成就会得到结果。下面我将分享如何为异步函数编写测试。

## 0x01 让我们开始吧
为了简单起见，需求是：
读取某一文件，并返回该文件的行数。

需要解决下边两个问题：
1. 由于异步函数的结果不会立刻返回，所以在测试中需要有一个东西来证明回调函数或promise对象返回了结果；
2. 由于得到响应的时间是未知的，所以我们还得设置一个超时时间。

假设你已经会为同步函数编写测试了【如果不会请先花几分钟看这篇 ![文章]() 】，所以一口气就写了如下的代码：

```javascript
    // files.js
    import fs from 'fs';

    export const linesCount = (fileName, onSuccess, onError) => {
        const processFile = (err, data) => {
            if (err) {
                onError('unable to open file ' + fileName);
            } else {
                onSuccess(data.toString().split('\n').length);
            }
        };

        fs.readFile(fileName, processFile);
    };
```

```javascript
    // files.test.js
    import { linesCount, linesCountP } from '../src/files';

    describe('test server side callback', () => {
        it('should return correct lines count for a valid file', () => {
            const onSuccess = (data) => {
                try {
                    expect(data).toBe(-100);
                } catch (error) {
                    // nothing
                }
            };

            linesCount('src/files.js', onSuccess);
        });
    });
```

上边的单测尽然通过了，我设置的可是 -100 行，没理由吧！出现该问题就是因为单测不知道这个回调什么时候操作完成，当做一个同步函数处理了，所以我们来解决第一个问题，加一个标识来验证回调操作完成。

```javascript
// files.test.js
    import { linesCount, linesCountP } from '../src/files';

    describe('test server side callback', () => {
        it('should return correct lines count for a valid file', (done) => {
            const onSuccess = (data) => {
                try {
                    expect(data).toBe(-100);
                } catch (error) {
                    // nothing
                }
            };

            linesCount('src/files.js', onSuccess);
        });
    });

```

通过查阅Jest的文档，了解到done就是那个处理回调的标识，它告诉单测这是个异步函数，但此时我们去执行，会看到一个超时的错误，默认时间是5秒。其实还是单测不知道回调什么时候完成的问题。

```javascript
    // files.test.js
    import { linesCount, linesCountP } from '../src/files';

    describe('test server side callback', () => {
        it('should return correct lines count for a valid file', (done) => {
            const onSuccess = (data) => {
                try {
                    expect(data).toBe(-100);
                    done();
                } catch (error) {
                    done(error);
                }
            };

            linesCount('src/files.js', onSuccess);
        });
    });
```

这个时候你会看到 Expected: -100，Received: 25，到这儿就把100改为25就结束了，但单测还没有写完，目前仅仅是做了一个正向测试。
