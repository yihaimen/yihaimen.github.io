---
title: "玩转UnitTest之巧妙处理依赖"
date: 2020-07-08T22:40:43+08:00
author: "易海门"
authorLink: "https://yihaimen.github.io"
description: ""
featuredImage: ""
featuredImagePreview: ""
categories: ["JavaScript"]
tags: ["JavaScript"]
license: "Creative Commons Attribution 4.0 International license"
draft: false
---

## 0x00 引言
大家好，我是以卖码为生的海门。今天想和大家探讨一下如何巧妙处理依赖，玩转 UnitTest。

我们平时使用的网络请求库 Axios ，时间格式化库 moment 等，这些对我们的项目来说都是依赖，可以说依赖无处不在，它的存在更容易发起网络请求，格式化时间等，但同样也带来了问题 - 很难为代码编写单元测试。

## 0x01 让我们开始吧
在正式进入主题之前，我会先告诉你，为了让我们的单测达到 F.A.I.R 原则的标准，我们需要解决的问题是：
1. 功能代码使用良好的设计，对依赖进行解耦，尽可能去除依赖；
2. 实在去除不了的依赖，如内部依赖，通过依赖注入构建松耦合的代码。测试代码使用一些技术进行替代，我们称这些技术叫测试替身 - 包括 Dummy、Fake、Stub、Mock和Spy。

需求：通过getCurrentPosition函数获取经纬度，定义一个供谷歌地图使用的URL，将该URL赋值给window.location。如果获取位置失败，则设置一条错误消息。

通过简单的需求分析和任务拆分，都会认为这个需求很简单。可是我们如何为它写自动化测试呢？没有写过UT的我，刚开始也是很懵的。跟我刚开始被要求为功能写单元测试的时候一样懵，完全不知道从那入手，怎么编写测试~我在搜索引擎中找到了一个解决方法，即借助Spike解决方案。

// 什么是Spike解决方案，怎么做技术分解 -> 另外写一篇文章

### 1、借助Spike技术编写原型代码

### 2、从中获得一些信息
* getCurrentPosition是一个异步函数，包含成功和失败两个回调函数
* 获取到经纬度时，拼接成一条URL
* 未获取到经纬度时，设置错误信息
* 将url赋值给location，此时浏览器会发生重定向

通过对原型代码的观察，发现其可测试性很差，而我们知道代码是否具有可测试性是个设计问题。所以，我们将解决第一个问题，即尽可能去除被测代码中的依赖。抽取函数，并将最少的数据作为参数传给它，对代码进行模块化设计。

### 3、模块化设计
有没有发现自己很多时候写的代码其实是原型代码，并没有设计可言！很多时候不写测试，根本发现不了这些问题，也不会对代码的设计有任何想法，更不用说什么设计模式地使用了。

接下来我们将spike阶段的原型代码进行拆分，是每个小功能都是一个小函数，每个小函数具有单一职责和最少依赖的特征。

![设计流程图]()

下边需要做的就是为每一个函数编写自动化测试，以验证它们的行为。
依赖在整个问题中占据了很重要的作用，编写自动化测试的第一步就是确定一个或多个不具有内部依赖的函数，这些函数应该成为自动化测试的起点。

首先找到createUrl这个函数，因为它没有任何其他依赖的代码测起来相对容易，只需要接收到正确的位置信息，然后创建一条符合预期的URL就可以了。

![code]()

> 在之前的文章中说到，多写几个有意义的正向测试，对代码行为验证很有帮助
![code-test]()

接下来根据测试列表中的用例为其编写反向测试、异常测试，之前介绍过方法就不再赘述了。

### 4、使用测试替身
createUrl这个函数很好测，因为它没有依赖需要处理，接下来剩下的都是有依赖需要处理的函数，即我们需要使用替身来解决第二个问题。

什么是替身？
代替真正依赖的对象，从而让自动化测试可以进行。就好比电影中的替身演员，当主角完不成不了某专业且高难度的动作时，此时替身演员就会上场，而替身演员的目的是为了让电影继续拍下去，比如主角没有找替身，要是残了的话，这部电影岂不是拍不下去了？！



通过上边地不懈努力，我们知道了如何处理依赖，最终完成了一个完全自动化测试的版本。

## 0x02 总结

## 0x03 参考